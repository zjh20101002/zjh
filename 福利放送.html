<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>稳定版抢票系统</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        body { background: #f5f7fa; padding: 30px 20px; min-height: 100vh; }
        .container { max-width: 500px; margin: 0 auto; background: #fff; border-radius: 12px; box-shadow: 0 2px 15px rgba(0,0,0,0.05); }
        .tab-btns { display: flex; }
        .tab-btn { width: 50%; padding: 15px; border: none; background: #fff; font-size: 16px; cursor: pointer; border-bottom: 1px solid #eee; }
        .tab-btn.on { color: #2563eb; border-bottom: 2px solid #2563eb; }
        .page { padding: 25px; display: none; }
        .page.show { display: block; }
        h2 { margin-bottom: 25px; color: #333; text-align: center; }
        .form-item { margin: 20px 0; }
        label { display: block; margin-bottom: 8px; color: #666; font-size: 14px; }
        input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 15px; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 6px; background: #2563eb; color: #fff; font-size: 15px; cursor: pointer; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .msg { padding: 12px; border-radius: 6px; margin: 15px 0; text-align: center; font-size: 14px; display: none; }
        .msg.success { background: #ecfdf5; color: #059669; display: block; }
        .msg.error { background: #fee2e2; color: #dc2626; display: block; }
        .msg.wait { background: #f8fafc; color: #64748b; display: block; }
        .tip { text-align: center; margin-top: 10px; color: #999; font-size: 13px; }
        .loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 999; }
        .loading.hide { display: none; }
        .loading-box { background: #fff; padding: 25px; border-radius: 10px; text-align: center; }
        .loading-spin { width: 40px; height: 40px; margin: 0 auto 15px; border: 4px solid #f0f0f0; border-top: 4px solid #2563eb; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .admin-list { margin-top: 20px; padding: 15px; border: 1px solid #eee; border-radius: 6px; max-height: 200px; overflow-y: auto; }
        .list-title { font-size: 16px; color: #333; margin-bottom: 10px; }
        .list-row { padding: 8px 0; border-bottom: 1px solid #f5f5f5; font-size: 14px; color: #666; display: flex; justify-content: space-between; }
        .list-empty { text-align: center; color: #999; font-size: 14px; padding: 10px 0; }
    </style>
</head>
<body>
    <!-- 加载弹窗 -->
    <div class="loading hide" id="loading">
        <div class="loading-box">
            <div class="loading-spin"></div>
            <div>处理中...</div>
        </div>
    </div>

    <div class="container">
        <!-- 切换按钮：纯CSS控制显示，无复杂逻辑 -->
        <div class="tab-btns">
            <button class="tab-btn on" onclick="changePage('user-page')">用户抢票</button>
            <button class="tab-btn" onclick="changePage('admin-page')">管理员配置</button>
        </div>

        <!-- 用户页面 -->
        <div class="page show" id="user-page">
            <h2>抢票通道</h2>
            <div class="msg wait" id="user-wait">等待管理员配置抢票信息</div>
            <div class="msg success" id="user-success" style="display: none;">抢票成功！</div>
            <div class="msg error" id="user-error" style="display: none;">抢票失败，无余票或已结束</div>
            <div class="msg error" id="crowd-error" style="display: none;">抢票人数过多，请稍后再试</div>

            <div class="form-item">
                <label>用户ID</label>
                <input type="text" id="user-id" placeholder="输入您的专属ID">
            </div>
            <button class="btn" id="grab-btn" onclick="grabTicket()" disabled>立即抢票</button>
            <div class="tip" id="user-tip">未配置抢票信息</div>
        </div>

        <!-- 管理员页面：点击按钮直接显示 -->
        <div class="page" id="admin-page">
            <h2>管理员中心</h2>
            <div class="form-item">
                <label>管理员密码</label>
                <input type="password" id="admin-pwd" placeholder="输入密码">
            </div>
            <button class="btn" onclick="checkAdminPwd()">验证解锁</button>

            <!-- 配置区域 -->
            <div id="admin-config" style="display: none; margin-top: 25px; padding-top: 25px; border-top: 1px dashed #eee;">
                <div class="form-item">
                    <label>抢票开始时间</label>
                    <input type="datetime-local" id="start-time">
                </div>
                <div class="form-item">
                    <label>抢票结束时间</label>
                    <input type="datetime-local" id="end-time">
                </div>
                <div class="form-item">
                    <label>总票数</label>
                    <input type="number" id="total-num" min="1" placeholder="设置总票数">
                </div>
                <button class="btn" onclick="saveAdminConfig()">保存配置</button>
                <div class="msg success" id="config-ok" style="display: none;">配置同步成功</div>

                <!-- 精准人数列表 -->
                <div class="admin-list">
                    <div class="list-title">抢票记录（共<span id="max-num">0</span>个名额）</div>
                    <div id="ticket-list" class="list-empty">暂无记录</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 核心数据
        let data = JSON.parse(localStorage.getItem('ticketSys')) || {
            isSet: false,
            start: '',
            end: '',
            total: 0,
            used: 0,
            records: []
        };
        let clicks = [];
        const ADMIN_PWD = '1002';

        // 页面加载初始化
        window.onload = () => {
            updateUser();
            updateAdminList();
            setInterval(() => {
                updateUser();
                updateAdminList();
            }, 1000);
        };

        // ------------- 页面切换：极简逻辑，无任何多余判定 -------------
        function changePage(pageId) {
            // 隐藏所有页面
            document.querySelectorAll('.page').forEach(page => page.classList.remove('show'));
            // 显示目标页面
            document.getElementById(pageId).classList.add('show');
            // 切换按钮样式
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('on'));
            event.target.classList.add('on');
        }

        // ------------- 管理员功能 -------------
        function checkAdminPwd() {
            if (document.getElementById('admin-pwd').value === ADMIN_PWD) {
                document.getElementById('admin-config').style.display = 'block';
                // 填充配置
                if (data.isSet) {
                    document.getElementById('start-time').value = data.start;
                    document.getElementById('end-time').value = data.end;
                    document.getElementById('total-num').value = data.total;
                }
                updateAdminList();
            } else {
                alert('密码错了');
            }
        }
        function saveAdminConfig() {
            const start = document.getElementById('start-time').value;
            const end = document.getElementById('end-time').value;
            const total = document.getElementById('total-num').value * 1;
            if (!start || !end || !total) { alert('填完所有项'); return; }
            if (new Date(start) >= new Date(end)) { alert('开始时间不能晚于结束'); return; }

            data.isSet = true;
            data.start = start;
            data.end = end;
            data.total = total;
            // 截取超出的记录
            if (data.records.length > total) {
                data.records = data.records.slice(0, total);
                data.used = total;
            }
            localStorage.setItem('ticketSys', JSON.stringify(data));
            
            document.getElementById('config-ok').style.display = 'block';
            setTimeout(() => document.getElementById('config-ok').style.display = 'none', 2000);
            updateUser();
            updateAdminList();
        }
        function updateAdminList() {
            const listEl = document.getElementById('ticket-list');
            const maxEl = document.getElementById('max-num');
            maxEl.textContent = data.total;

            if (data.total === 0) {
                listEl.innerHTML = '<div class="list-empty">先设置总票数</div>';
                return;
            }
            if (data.records.length === 0) {
                listEl.innerHTML = '<div class="list-empty">暂无记录</div>';
                return;
            }
            // 渲染列表，最多显示总票数条
            let html = '';
            data.records.slice(0, data.total).forEach((item, i) => {
                html += `<div class="list-row"><span>${i+1}. ${item.id}</span><span>${item.time}</span></div>`;
            });
            listEl.innerHTML = html;
        }

        // ------------- 用户功能 -------------
        function updateUser() {
            const btn = document.getElementById('grab-btn');
            const wait = document.getElementById('user-wait');
            const tip = document.getElementById('user-tip');
            const now = new Date();

            if (!data.isSet) {
                btn.disabled = true;
                btn.textContent = '未开启';
                tip.textContent = '管理员未配置';
                wait.style.display = 'block';
                return;
            }

            wait.style.display = 'none';
            const start = new Date(data.start);
            const end = new Date(data.end);
            const remain = data.total - data.used;
            tip.textContent = `时间：${fmtTime(data.start)}-${fmtTime(data.end)} | 剩余：${remain}张`;

            if (now < start) {
                btn.disabled = true;
                btn.textContent = `倒计时：${countDown(start)}`;
            } else if (now > end) {
                btn.disabled = true;
                btn.textContent = '已结束';
            } else {
                btn.disabled = remain <= 0;
                btn.textContent = remain > 0 ? '立即抢票' : '票已完';
            }
        }
        function grabTicket() {
            const id = document.getElementById('user-id').value.trim();
            const now = Date.now();
            const start = new Date(data.start).getTime();
            const end = new Date(data.end).getTime();
            const remain = data.total - data.used;

            if (!id) { alert('输ID'); return; }
            if (now < start || now > end || remain <= 0) {
                document.getElementById('user-error').style.display = 'block';
                setTimeout(() => document.getElementById('user-error').style.display = 'none', 2000);
                return;
            }

            // 1秒内多人点击拦截
            clicks = clicks.filter(t => now - t < 1000);
            if (clicks.length >= 2) {
                document.getElementById('crowd-error').style.display = 'block';
                setTimeout(() => document.getElementById('crowd-error').style.display = 'none', 2000);
                return;
            }
            clicks.push(now);

            // 显示加载
            document.getElementById('loading').classList.remove('hide');
            setTimeout(() => {
                // 新增记录
                data.records.unshift({
                    id: id,
                    time: new Date().toLocaleString()
                });
                data.used++;
                // 控制记录数不超过总票数
                if (data.records.length > data.total) {
                    data.records.pop();
                }
                localStorage.setItem('ticketSys', JSON.stringify(data));

                document.getElementById('loading').classList.add('hide');
                document.getElementById('user-success').style.display = 'block';
                setTimeout(() => document.getElementById('user-success').style.display = 'none', 2000);
                document.getElementById('user-id').value = '';
                updateUser();
                updateAdminList();
            }, 800);
        }

        // ------------- 工具函数 -------------
        function fmtTime(str) {
            return new Date(str).toLocaleString('zh-CN', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
        }
        function countDown(target) {
            const diff = target - Date.now();
            if (diff <= 0) return '0秒';
            const h = Math.floor(diff / 3600000);
            const m = Math.floor((diff % 3600000) / 60000);
            const s = Math.floor((diff % 60000) / 1000);
            return `${h}时${m}分${s}秒`;
        }
    </script>
</body>
</html>